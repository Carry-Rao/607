<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>日记</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="shortcut icon" href="icon.ico" type="image/x-icon">
    <style>
        /* 原有样式保持不变 */
        h1 { color: white; text-align: center; }
        body { background: linear-gradient(to right, #1d1c1c, #585756); }
        form { 
            margin: 0 auto; 
            width: 330px;
            height: 330px;
            padding: 20px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 0 10px #000;
        }
        /* 新增日记展示样式 */
        #diary-container {
            display: none;
            margin: 20px auto;
            width: 80%;
            color: white;
        }
        .diary-entry {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }
        .diary-date {
            font-size: 1.2em;
            color: #4CAF50;
            margin-bottom: 5px;
        }
        h1 {
            color: white;
            text-align: center;
        }
        body {
            background: /*渐变色*/ linear-gradient(to right, #1d1c1c, #585756);
        }
        form {
            margin: 0 auto;
            width: 330px;
            height: 230px;
            padding: 20px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 0 10px #000;
        }
        label {
            display: block;
            margin-top: 10px;
        }
        input[type="text"], input[type="password"] {
            width: 90%;
            padding: 10px;
            margin-top: 5px;
            border-radius: 5px;
            border: none;
            box-shadow: 0 0 5px #000;
        }
        input[type="submit"] {
            background-color: #4CAF50;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button {
            background-color: #f04944;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        #fp {
            background-color: rgb(233, 219, 29);
        }
        #error {
            color: red;
            margin-top: 10px;
        }
    </style>
</head>
<body>    
    <div id="navbar">
        <div class="nbb" onclick="window.location.href='/index.html'">首页</div>
        <div class="nbb" onclick="window.location.href='/news.html'">资源</div>
        <div class="nbb" onclick="window.location.href='/cm.html'">同学</div>
        <div class="nbb" onclick="window.location.href='/about.html'">回忆</div>
        <img src="img/user.png" alt="logo" class="logo" id="user"onclick="window.location.href='/aboutme.html'">
    </div>
    <form action="" method="post" onsubmit="event.preventDefault(); login();" id="loginForm">
        <p>若是首次登入日记，您本次输入的密码将成为您日记的加密凭证</p>
        <label for="password">密码:</label>
        <input type="password" id="password" name="password"><br><br>
        <input type="submit" value="登录">
        <div id="error"></div>
    </form>

    <div id="diary-container">
        <button onclick="location.reload()">隐藏</button>
        <button onclick="location.href='/diary/new.html'" style="color: green'">新日记</button>
        <h1 id="name">XXX的日记</h1>
        <div id="diary-list"></div>
    </div>

<script>
   function sha256_digest(message) {
        // 使用Web Crypto API生成SHA-256哈希
        return crypto.subtle.digest('SHA-256', new TextEncoder().encode(message))
            .then(function(hash) {
                return hex(hash);
            });
    }

    function hex(buffer) {
        var hexCodes = [];
        var view = new DataView(buffer);
        for (var i = 0; i < view.byteLength; i++) {
            var value = view.getUint8(i).toString(16);
            if (value.length === 1) {
                hexCodes.push('0');
            }
            hexCodes.push(value);
        }
        return hexCodes.join('');
    }

    function getCookie(name) {
        var arr, reg = new RegExp("(^| )" + name + "=([^;]*)(;|$)");
        if (arr = document.cookie.match(reg))
            return unescape(arr[2]);
        else
            return null;    
    }

    function login() {
        var username = getCookie("username");
        var password = document.getElementById("password").value;
        if (!username || !password) {
            // document.getElementById("error").innerHTML = "用户名或密码不能为空！";
            // return;
        }

        sha256_digest(password).then(function(sha256) {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "https://607bg.carryrao.top/diary", true);
            xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            // var xhr = '{"statue": "success","name": "饶子阳","diary": {"2025/3/13": "这是一个测试。欢迎来到60……"}}';
            
            xhr.onload = function() {
                if (xhr.status === 200) {
                    var result = JSON.parse(xhr/*.responseText*/);
                    if (result.status === "success") {
                        document.getElementById("loginForm").style.display = 'none';
                        document.getElementById("diary-container").style.display = 'block';
                        document.getElementById ("name").innerText = result.name + "的日记";
                        showDiaries(result.diary);
                    } else {
                        showError("遇到错误，请检查用户是否被禁用！");
                    }
                } else {
                    handleHttpError(xhr.status);
                }
            };
            
            xhr.send("username=" + encodeURIComponent(username) + "&password=" + encodeURIComponent(sha256));
        });
    }

    function showDiaries(diaries) {
        var container = document.getElementById("diary-list");
        container.innerHTML = '';
        
        // 遍历所有日记条目
        Object.keys(diaries).forEach(date => {
            var entry = document.createElement('div');
            entry.className = 'diary-entry';
            
            entry.onclick = window.location.href = '/diary.html?date=' + date;

            var dateElem = document.createElement('div');
            dateElem.className = 'diary-date';
            dateElem.textContent = date;
            
            var content = document.createElement('p');
            content.textContent = diaries[date];

            entry.appendChild(dateElem);
            entry.appendChild(content); 
            entry.appendChild(full);
            container.appendChild(entry);
        });
    }

    function showError(httperror) {
        document.getElementById("error").innerHTML = "遇到http错误：" + String(httperror);
    }
    
    function handleHttpError(status) {
        const errors = {
            401: "无法使用密码解开日记！",
            530: "服务器错误！"
        };
        document.getElementById("error").innerHTML = errors[status] || "未知错误";
    }
</script>
</body>
</html>
