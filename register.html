<!DOCTYPE html>
<html>
<head>
	<title>注册</title>
    <meta charset="utf-8">
    <link rel="shortcut icon" href="./icon.ico" type="image/x-icon">
    <style>
        h1 {
            color: white;
            text-align: center;
        }
        body {
            background: /*渐变色*/ linear-gradient(to right, #1d1c1c, #585756);
        }
        form {
            margin: 0 auto;
            width: 330px;
            height: 400px;
            padding: 20px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 0 10px #000;
        }
        label {
            display: block;
            margin-top: 10px;
        }
        input[type="text"], input[type="password"] {
            width: 90%;
            padding: 10px;
            margin-top: 5px;
            border-radius: 5px;
            border: none;
            box-shadow: 0 0 5px #000;
        }
        input[type="submit"] {
            background-color: #f04944;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button {
            background-color: #f04944;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        #error {
            color: red;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>注册</h1>
    <form action="" method="post" onsubmit="event.preventDefault(); register();">
        <div id="tos">
            <input type="radio" name="tos" value="teacher" id="teacher">
            我是老师
            <input type="radio" name="tos" value="student" id="student">
            我是学生
        </div>
        <label for="name">真实姓名:</label>
        <input type="text" id="name" name="name"><br>
        <label for="username">用户名:</label>
        <input type="text" id="username" name="username"><br>
        <label for="password">密码:</label>
        <input type="password" id="password" name="password"><br>
        <label for="yzpassword" id="yzlabel">确认密码:</label>
        <input type="password" id="yzpassword" name="yzpassword"><br><br>
        <input type="submit" value="注册">
        <p id="error" style="color:red"></p>
    </form>
    <p id="ok" style="display: none;">注册成功，请等待管理员审核</p>
</body>
<script>
    function sha256_digest(message) {
        // 使用Web Crypto API生成SHA-256哈希
        return crypto.subtle.digest('SHA-256', new TextEncoder().encode(message))
            .then(function(hash) {
                return hex(hash);
            });
    }

    function hex(buffer) {
        var hexCodes = [];
        var view = new DataView(buffer);
        for (var i = 0; i < view.byteLength; i++) {
            var value = view.getUint8(i).toString(16);
            if (value.length === 1) {
                hexCodes.push('0');
            }
            hexCodes.push(value);
        }
        return hexCodes.join('');
    }

    function register() {
        document.getElementById("error").innerHTML = "";
        var tos = document.getElementsByName("tos");
        var tosValue = "";
        for (var i = 0; i < tos.length; i++) {
            if (tos[i].checked) {
                tosValue = tos[i].value;
                break;
            }
        }
        if (tosValue == "") {
            document.getElementById("error").innerHTML = "请选择注册身份";
            return;
        }
        var name = document.getElementById("name").value;
        var username = document.getElementById("username").value;
        var password = document.getElementById("password").value;
        var yzpassword = document.getElementById("yzpassword").value;
        if (name == "" || username == "" || password == "" || yzpassword == "") {
            document.getElementById("error").innerHTML = "请填写所有必填项";
            return;
        }
        if (password != yzpassword) {
            document.getElementById("error").innerHTML = "两次输入的密码不一致";
            return;
        }
        sha256_digest(password)
           .then(function(hash) {
                var xhr = new XMLHttpRequest();
                xhr.open("POST", "https://607bg.carryrao.top/register", true);
                xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            var response = JSON.parse(xhr.responseText);
                            if (response.status === "success") {
                                document.getElementById("ok").style.display = "block";
                            } else {
                                document.getElementById("error").innerHTML = response.message;
                            }
                        } else if (xhr.status === 530) {
                            document.getElementById("error").innerHTML = "服务器错误";
                        } else {
                            document.getElementById("error").innerHTML = response.message;
                        } 
                    }
                };
                xhr.send("tos=" + tosValue + "&name=" + name + "&username=" + username + "&password=" + hash);
            });
    }
</script>
</html>