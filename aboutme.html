<!DOCTYPE html>
<html>

<head>
    <title>设置</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="icon.ico" type="image/x-icon">
    <link rel="stylesheet" href="style.css">
    <style>
        h1,
        h2 {
            color: white;
        }

        h1 {
            color: white;
            text-align: center;
        }

        body {
            background:
                /*渐变色*/
                linear-gradient(to right, #1d1c1c, #585756);
        }

        form {
            margin: 0 auto;
            width: 330px;
            height: 250px;
            padding: 20px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 0 10px #000;
        }

        label {
            display: block;
            margin-top: 10px;
        }

        input[type="text"],
        input[type="password"],
        input[type="email"],
        input[type="phone"] {
            width: 90%;
            padding: 10px;
            margin-top: 5px;
            border-radius: 5px;
            border: none;
            box-shadow: 0 0 5px #000;
        }

        input[type="submit"] {
            background-color: #4CAF50;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        button {
            background-color: #f04944;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        #fp {
            background-color: rgb(233, 219, 29);
        }

        #error {
            color: red;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <h1>设置</h1>
    <h2>用户名</h2>
    <input type="text" placeholder="请输入用户名" readonly id="username">
    <button onclick="cnn ()" id="userb">修改</button>
    <h2>手机号</h2>
    <input type="phone" placeholder="请输入手机号" readonly id="phone">
    <button onclick="cpn ()" id="phoneb">修改</button>
    <h2>微信</h2>
    <input type="text" placeholder="请输入微信号" readonly id="wechat">
    <button onclick="cwx ()" id="wechatb">修改</button>
    <h2>邮箱</h2>
    <input type="email" placeholder="请输入邮箱" readonly id="email">
    <button onclick="cem ()" id="emailb">修改</button>
    <h2>QQ</h2>
    <input type="text" placeholder="请输入QQ号" readonly id="qq">
    <button onclick="cqq ()" id="qqb">修改</button>
    <h2>更改密码</h2>
    <input type="password" placeholder="请输入旧密码" id="oldpw" style="display: none;">
    <input type="password" placeholder="请输入新密码" id="newpw" style="display: none;">
    <input type="password" placeholder="请再次输入新密码" id="newpw2" style="display: none;">
    <button onclick="cpw ()" id="pwb">修改密码</button>
</body>
<script>
    //从后端获取用户名、手机号、微信、邮箱、QQ
function getCookie(name) {
    let cookieArr = document.cookie.split(";");
    for (let i = 0; i < cookieArr.length; i++) {
        let cookiePair = cookieArr[i].split("=");
        if (name === cookiePair[0].trim()) {
            return decodeURIComponent(cookiePair[1]);
        }
    }
    return null; // 如果未找到，则返回null
}
let username = getCookie("username");
var xhr = new XMLHttpRequest();
xhr.open("POST", "https://607bg.carryrao.top/aboutme?name=" + username, true);
xhr.onreadystatechange = function () {
    if (xhr.readyState === 4 && xhr.status === 200) {
        let result = JSON.parse(xhr.responseText);
        console.log(result);
        if (result.status === "success") {
            document.getElementById("username").value = result.data.name;
            document.getElementById("phone").value = result.data.phone;
            document.getElementById("wechat").value = result.data.wechat;
            document.getElementById("email").value = result.data.email;
            document.getElementById("qq").value = result.data.qq;
        } else {
            document.getElementById("error").innerHTML = result.error;
            console.log(result.error);
            
        }
    }
};
xhr.send();

function cnn() {
    //将只读的用户名输入框改为可编辑状态
    document.getElementById("username").readOnly = false;
    //将用户名输入框的placeholder改为"请输入新的用户名"
    document.getElementById("username").placeholder = "请输入新的用户名";
    //将按钮改为"确认修改"
    document.getElementById("userb").innerHTML = "确认修改";
    //将按钮的onclick事件改为确认修改用户名的函数
    document.getElementById("userb").onclick = cnn2;
}
function cnn2() {
    let newusername = document.getElementById("username").value;
    //将用户名输入框改为只读状态
    document.getElementById("username").readOnly = true;
    //将用户名输入框的placeholder改为"请输入用户名"
    document.getElementById("username").placeholder = "请输入用户名";
    //将按钮改为"修改"
    document.getElementById("userb").innerHTML = "修改";
    //将按钮的onclick事件改为修改用户名的函数
    document.getElementById("userb").onclick = cnn;
    if (newusername === "" || newusername === null) {
        alert("请输入有效的用户名");
        return;
    }
    let xhr = new XMLHttpRequest();
    xhr.open("POST", "https://607bg.carryrao.top/change/name?username=" + username + "&newusername=" + newusername, true);
    xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
            let result = JSON.parse(xhr.responseText);
            console.log(result);
            if (result.status === "success") {
                document.getElementById("username").value = result.data.name;
                alert("修改成功");
            } else {
                document.getElementById("error").innerHTML = result.error;
            }
        }
    };
    xhr.send();
}

function cpn() {
    document.getElementById("phone").readOnly = false;
    document.getElementById("phone").placeholder = "请输入新的手机号";
    document.getElementById("phoneb").innerHTML = "确认修改";
    document.getElementById("phoneb").onclick = cpn2;
}
function cpn2() {
    let newphone = document.getElementById("phone").value;
    document.getElementById("phone").readOnly = true;
    document.getElementById("phone").placeholder = "请输入手机号";
    document.getElementById("phoneb").innerHTML = "修改";
    document.getElementById("phoneb").onclick = cpn;
    if (newphone === "" || newphone === null) {
        alert("请输入有效的手机号");
        return;
    }
    let xhr = new XMLHttpRequest();
    xhr.open("POST", "https://607bg.carryrao.top/change?type=phone&username=" + username + "&newphone=" + newphone, true);
    xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
            let result = JSON.parse(xhr.responseText);
            console.log(result);
            if (result.status === "success") {
                document.getElementById("phone").value = result.data.phone;
                alert("修改成功");
            } else {
                document.getElementById("error").innerHTML = result.error;
            }
        }
    };
    xhr.send();
}

function cwx() {
    document.getElementById("wechat").readOnly = false;
    document.getElementById("wechat").placeholder = "请输入新的微信号";
    document.getElementById("wechatb").innerHTML = "确认修改";
    document.getElementById("wechatb").onclick = cwx2;
}
function cwx2() {
    let newwechat = document.getElementById("wechat").value;
    document.getElementById("wechat").readOnly = true;
    document.getElementById("wechat").placeholder = "请输入微信号";
    document.getElementById("wechatb").innerHTML = "修改";
    document.getElementById("wechatb").onclick = cwx;
    if (newwechat === "" || newwechat === null) {
        alert("请输入有效的微信号");
        return;
    }
    let xhr = new XMLHttpRequest();
    xhr.open("POST", "https://607bg.carryrao.top/change?type=wechat&username=" + username + "&newwechat=" + newwechat, true);
    xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
            let result = JSON.parse(xhr.responseText);
            console.log(result);
            if (result.status === "success") {
                document.getElementById("wechat").value = result.data.wechat;
                alert("修改成功");
            } else {
                document.getElementById("error").innerHTML = result.error;
            }
        }
    };
    xhr.send();
}

function cem() {
    document.getElementById("email").readOnly = false;
    document.getElementById("email").placeholder = "请输入新的邮箱";
    document.getElementById("emailb").innerHTML = "确认修改";
    document.getElementById("emailb").onclick = cem2;
}
function cem2() {
    let newemail = document.getElementById("email").value;
    document.getElementById("email").readOnly = true;
    document.getElementById("email").placeholder = "请输入邮箱";
    document.getElementById("emailb").innerHTML = "修改";
    document.getElementById("emailb").onclick = cem;
    if (newemail === "" || newemail === null) {
        alert("请输入有效的邮箱");
        return;
    }
    let xhr = new XMLHttpRequest();
    xhr.open("POST", "https://607bg.carryrao.top/change?type=email?username=" + username + "&newemail=" + newemail, true);
    xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
            let result = JSON.parse(xhr.responseText);
            console.log(result);
            if (result.status === "success") {
                document.getElementById("email").value = result.data.email;
                alert("修改成功");
            } else {
                document.getElementById("error").innerHTML = result.error;
            }
        }
    };
    xhr.send();
}

function cqq() {
    document.getElementById("qq").readOnly = false;
    document.getElementById("qq").placeholder = "请输入新的QQ号";
    document.getElementById("qqb").innerText = "确认修改";
    document.getElementById("qqb").onclick = cqq2;
}
function cqq2() {
    let newqq = document.getElementById("qq").value;
    document.getElementById("qq").readOnly = true;
    document.getElementById("qq").placeholder = "请输入QQ号";
    document.getElementById("qqb").innerText = "修改";
    document.getElementById("qqb").onclick = cqq;
    if (newqq === "" || newqq === null) {
        alert("请输入有效的QQ号");
        return;
    }
    let xhr = new XMLHttpRequest();
    xhr.open("POST", "https://607bg.carryrao.top/change?type=qq&username=" + username + "&newqq=" + newqq, true);
    xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
            let result = JSON.parse(xhr.responseText);
            console.log(result);
            if (result.status === "success") {
                document.getElementById("qq").value = result.data.qq;
                alert("修改成功");
            } else {
                document.getElementById("error").innerHTML = result.error;
            }
        }
    };
    xhr.send();
}

function sha256_digest(message) {
    // 使用Web Crypto API生成SHA-256哈希
    return crypto.subtle.digest('SHA-256', new TextEncoder().encode(message))
        .then(function (hash) {
            return hex(hash);
        });
}

function hex(buffer) {
    var hexCodes = [];
    var view = new DataView(buffer);
    for (var i = 0; i < view.byteLength; i++) {
        var value = view.getUint8(i).toString(16);
        if (value.length === 1) {
            hexCodes.push('0');
        }
        hexCodes.push(value);
    }
    return hexCodes.join('');
}

function cpw() {
    document.getElementById("oldpw").style.display = "block";
    document.getElementById("newpw").style.display = "block";
    document.getElementById("newpw2").style.display = "block";
    document.getElementById("pwb").onclick = cpw2;
}

function cpw2() {
    let oldpw = document.getElementById("oldpw").value;
    let newpw = document.getElementById("newpw").value;
    let newpw2 = document.getElementById("newpw2").value;
    document.getElementById("oldpw").style.display = "none";
    document.getElementById("newpw").style.display = "none";
    document.getElementById("newpw2").style.display = "none";
    document.getElementById("pwb").onclick = cpw;
    if (newpw !== newpw2) {
        alert("两次输入的密码不一致");
        return;
    }
    if (oldpw === "" || newpw === "") {
        alert("密码不能为空");
        return;
    }
    sha256_digest(oldpw).then(function (oldpwhash) {
        sha256_digest(newpw).then(function (newpwhash) {
            let xhr = new XMLHttpRequest();
            xhr.open("POST", "https://607bg.carryrao.top/changepw?username=" + username + "&oldpw=" + oldpwhash + "&newpw=" + newpwhash, true);
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    let result = JSON.parse(xhr.responseText);
                    console.log(result);
                    if (result.status === "success") {
                        alert("修改成功");
                    } else {
                        document.getElementById("error").innerHTML = result.error;
                    }
                }
            };
            xhr.send();
        });
    });
}

</script>

</html>
